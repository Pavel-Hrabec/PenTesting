# Prerequisites 
# https://learn.microsoft.com/en-us/powershell/azure/install-azps-windows?view=azps-12.1.0&tabs=powershell&pivots=windows-psgallery
# Register Microsoft.Storage

# Parameters
$subscriptionId = "FILL_OUT_YOUR_UNIQUE_SUBSCRIPTION_ID"
$resourceGroupName = "BlobStoragePentest" # Replace
$storageAccountName = "putuniquestoragenamehere" # Change required (everything lower case)
$containerName = "public"
$location = "West Europe"
# Path to the file you want to upload
$filePath = "./secret.txt" 
$filePath2 = "./secrets.txt"  


# Authenticate to Azure
Update-AzConfig -EnableLoginByWam $false
Update-AzConfig -LoginExperienceV2 "Off"
Update-AzConfig -DefaultSubscriptionForLogin $subscriptionId
Connect-AzAccount #-SubscriptionId $subscriptionId 

# Set the context to the specified subscription
Set-AzContext -SubscriptionId $subscriptionId

# Create a resource group
New-AzResourceGroup -Name $resourceGroupName -Location $location

# Create a storage account
$storageAccount = New-AzStorageAccount -ResourceGroupName $resourceGroupName -Name $storageAccountName -SkuName "Standard_LRS" -Location $location -AllowBlobPublicAccess $true

# Get storage account context
$ctx = $storageAccount.Context

# Create a public blob container
New-AzStorageContainer -Name $containerName -Context $ctx -PublicAccess Container

# Upload a file to the blob container
Set-AzStorageBlobContent -File $filePath -Container $containerName -Blob ([System.IO.Path]::GetFileName($filePath)) -Context $ctx
Set-AzStorageBlobContent -File $filePath2 -Container $containerName -Blob ([System.IO.Path]::GetFileName($filePath2)) -Context $ctx

Write-Output "Public blob storage container '$containerName' created in storage account '$storageAccountName'"
Write-Output "File '$filePath' uploaded to container '$containerName'"
